---
- name: Check if pyenv is installed in pyenv_root
  stat: path="{{ pyenv_root }}/bin/pyenv"
  register: pyenv
  become: yes
  become_user: "{{ pyenv_user }}"

- block:
  - include: packages.yml
  # http://hakunin.com/six-ansible-practices
  - name: Ensure github.com is a known host
    lineinfile:
      dest: "~/.ssh/known_hosts"
      create: yes
      state: present
      line: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
      regexp: "^github\\.com"
  - name: Download pyenv installer
    get_url: >
        url=https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer
        dest=/tmp/pyenv-installer
        mode=0700
        sha256sum={{pyenv_installer_sha256}}
  - name: Run pyenv installer
    command: >-
      /tmp/pyenv-installer
      creates: "{{ pyenv_root }}/bin/pyenv"
    environment:
      PYENV_ROOT: "{{ pyenv_root }}"
    become: yes
    become_user: "{{ pyenv_user }}"
  - name: Remove pyenv installer
    file: path=/tmp/pyenv-installer state=absent
  when: not pyenv.stat.exists
